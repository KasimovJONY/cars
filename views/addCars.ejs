<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Add Cars</title>
    <%- include('includes/links') -%>
</head>
<body>
    <%- include('includes/header') -%>
    <div class="container">
        <div>
            <a href="/settings" class="text-decoration-none text-light d-flex align-items-center">
                <i class="fa-solid fa-angle-left me-1"></i>
                <span style="margin-bottom: 3px;">Back</span>
            </a>
        </div>
        <div class="d-flex gap-5 mb-5">
            <div class="w-50 bg-dark px-5 py-1 rounded-3">
                <h3 class="text-center">Add Sold Cars</h3>
                <form action="/post/cars" method="post"  enctype="multipart/form-data">
                    <div class="py-2">
                        <label for="categoryName">Category</label>
                        <select type="text" name="category" id="categoryName" value="0" class="form-control" required>
                            <option>Select</option>
                        </select>
                    </div>
                    <div class="py-2">
                        <label for="yearOfCar">Yili</label>
                        <input type="number" name="yearOfCar" id="yearOfCar" class="form-control" required placeholder="1999">
                    </div>
                    <div class="py-2">
                        <label for="colorOfCar">Rangi</label>
                        <input type="color" name="colorOfCar" id="colorOfCar" class="form-control" required>
                    </div>
                    <div class="py-2">
                        <label for="probeg">Probeg </label>
                        <input type="number" name="probeg" id="probeg" class="form-control" required placeholder="0 km">
                    </div>
                    <div class="py-2">
                        <div>
                            <label for="metan">Metan bormi?</label>
                        </div>
                        <div class="btn-group" role="group" aria-label="Basic radio toggle button group ">
                            <input type="radio" class="btn-check" name="btnradio" id="btnradio1" value="ha" autocomplete="off" checked>
                            <label class="btn btn-outline-primary" for="btnradio1">Ha</label>
                          
                            <input type="radio" class="btn-check" name="btnradio" id="btnradio2" value="yoq" autocomplete="off">
                            <label class="btn btn-outline-primary " for="btnradio2">Yo'q</label>
                        </div>
                    </div>
                    <div class="py-2">
                        <label for="file">Mashina rasmi</label>
                        <input type="file" name="file" id="file" class="form-control" required>
                    </div>
                    <div class="py-2 float-end">
                        <button type="submit" class="btn btn-info">Send</button>
                    </div>
                </form>
                
            </div>
            <div class="w-50">
                <h3>Sold Cars</h3>
                <table class="table table-dark table-bordered border-light py-3" style="background-color: rgb(66 64 64) !important;">
                    <thead>
                        <tr>
                            <th>№</th>
                            <th>Nomi</th>
                            <th>Yili</th>
                            <th>Rangi</th>
                            <th>Probeg</th>
                            <th>Metan</th>
                            <th style="width: 20%;" >Amallar</th>
                        </tr>
                    </thead>
                    <tbody id="tbodySoldCars"></tbody>
                </table>
            </div>
        </div>
    </div>
    <script>
        let dataCars = []
        let selectCaregory = document.querySelector('#categoryName')
        function getCategories(tag){
            fetch(`http://localhost:5000/api/categories`)
            .then(res => res.json())
            .then((data) => {
            console.log("Kategoriya ma'lumotlari:", data);
            console.log("Tagning avvalgi qiymati:", tag.value);
            tag.innerHTML = '';
            data.forEach((el) => {
                let opt = document.createElement('option');
                opt.value = el.id;
                opt.textContent = el.name;
                opt.classList = "opt";
                if (tag.value == el.name) {
                    opt.selected = true;
                }
                tag.appendChild(opt);
            });
            console.log("Tagning yangi qiymati:", tag.value);
        })
        }
        getCategories(selectCaregory)
        function getSoldCars() {
            fetch('http://localhost:5000/api/soldCars')
                .then(res => res.json())
                .then((data)=>{
                    console.log(data);
                    tableSoldCars(data)
                    dataCars = []
                    dataCars = data
                })
        }
        getSoldCars()
        function tableSoldCars(data){
            let tbody = document.querySelector('#tbodySoldCars');
            tbody.innerHTML = '';
            data.forEach((el, index) => {
                let row = `<tr>
                    <td>${index +1}</td>
                    <td>${el.name}</td>
                    <td>${el.year}</td>
                    <td >
                        <div style="background-color: ${el.color}; color: ${el.color}">1</div>    
                    </td>   
                    <td>${el.probeg}</td>
                    <td>${el.status}</td>
                    <td>
                        <button class="btn btn-outline-light" onclick="openDeleteModal('${el.id}')"><i class="ai-trash-can"></i></button>
                        <button class="btn btn-outline-light" onclick="openEditModal('${el.id}')">
                            <i class="ai-edit"></i>
                        </button>
                    </td>
                </tr>`
                tbody.innerHTML += row;
            });
        }
        function openDeleteModal(id){
            let modal = document.createElement('div');
            modal.innerHTML = `
                <div class="modal fade text-black" id="Modal${id}" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h1 class="modal-title fs-5" id="exampleModalLabel">Do you want to delete? </h1>
                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                            </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                                    <button type="submit" class="btn btn-danger " onclick="deleteCar('${id}')">Delete</button>
                                </div>
                        </div>
                    </div>
                </div>`;

            document.body.appendChild(modal);
            new bootstrap.Modal(document.getElementById(`Modal${id}`)).show();
         }
         function deleteCar(id){
            fetch(`/api/soldCars/delete/${id}`,{
                method : 'DELETE', 
                headers: {"Content-Type": "application/json",},
            })
            .then(res => res.json())
            .then((data)=>{
                console.log(data);
                closeModal(id)
                getSoldCars()
            })
         }
         function openEditModal(id){
            
            let dataThisCar = dataCars.find(car => car.id == id)
            console.log(dataThisCar);
            
            let modal = document.createElement('div');
            modal.innerHTML = `
                <div class="modal fade text-black" id="Modal${id}" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h1 class="modal-title fs-5" id="exampleModalLabel">Edit: ${dataThisCar.name} </h1>
                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                            </div>
                            <div class="modal-body">
                                <div class="py-1">
                                    <label for="categoryName">Category</label>
                                    <select type="text" name="category" id="editCategoryName${id}" class="form-control" required>
                                    </select>
                                </div>
                                <div class="py-1">
                                    <label for="yearOfCar">Yili</label>
                                    <input type="number" name="yearOfCar" id="yearOfCarEdit" value="${dataThisCar.year}" class="form-control" required placeholder="1999">
                                </div>
                                <div class="py-1">
                                    <label for="colorOfCar">Rangi</label>
                                    <input type="color" name="colorOfCar" id="colorOfCarEdit" value="${dataThisCar.color}" class="form-control" required>
                                </div>
                                <div class="py-1">
                                    <label for="probeg">Probeg </label>
                                    <input type="number" name="probeg" id="probegEdit" value="${dataThisCar.probeg}" class="form-control" required placeholder="0 km">
                                </div>
                                <div class="py-1">
                                    <div>
                                        <label for="metan">Metan bormi?</label>
                                    </div>
                                    <div class="btn-group" role="group" aria-label="Basic radio toggle button group ">
                                        <input type="radio" class="btn-check" name="btnradioEdit" id="btnradio1${dataThisCar.id}" value="ha" autocomplete="off" checked>
                                        <label class="btn btn-outline-primary" for="btnradio1${dataThisCar.id}">Ha</label>
                                    
                                        <input type="radio" class="btn-check" name="btnradioEdit" id="btnradio2${dataThisCar.id}" value="yoq" autocomplete="off">
                                        <label class="btn btn-outline-primary " for="btnradio2${dataThisCar.id}">Yo'q</label>
                                    </div>
                                </div>
                                <div class="py-1">
                                    <label for="fileEdit">Mashina rasmi</label>
                                    <input type="file" name="fileEdit" id="fileEdit" class="form-control" required>
                                </div>
                                
                            </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                                    <button type="submit" class="btn btn-primary " onclick="editCar('${id}')">Save changes</button>
                                </div>
                        </div>
                    </div>
                </div>`;

            document.body.appendChild(modal);
            let editCategoryName = document.querySelector(`#editCategoryName${id}`) 
            getCategories(editCategoryName)
            new bootstrap.Modal(document.getElementById(`Modal${id}`)).show();
         }

         function editCar(id) {
    let isValid = true;
    let value = 0;
    let editCategoryName = document.querySelector(`#editCategoryName${id}`);
    let yearOfCarEdit = document.querySelector('#yearOfCarEdit');
    let colorOfCarEdit = document.querySelector('#colorOfCarEdit');
    let probegEdit = document.querySelector('#probegEdit');
    let fileEdit = document.querySelector('#fileEdit');
    let selectedRadio = document.querySelector('input[name="btnradioEdit"]:checked');
    
    editCategoryName.addEventListener('change', (e)=>{
        value = e.target.value;
        console.log("Change val:", value);
    })
    console.log(editCategoryName.value, "jonjojo");
    
    let fields = [
        { element: editCategoryName, name: "Kategoriya" },
        { element: yearOfCarEdit, name: "Mashina yili" },
        { element: colorOfCarEdit, name: "Mashina rangi" },
        { element: probegEdit, name: "Probeg" }
    ];

    fields.forEach(field => {
        let input = field.element;
        let errorSpan = input.nextElementSibling;

        if (input.value.trim() === '') {
            if (!errorSpan || errorSpan.className !== "error-text") {
                errorSpan = document.createElement("span");
                errorSpan.className = "error-text";
                errorSpan.style.color = "red";
                errorSpan.style.fontSize = "12px";
                errorSpan.innerText = `${field.name} maydonini to'ldiring!`;
                input.after(errorSpan);
            }
            isValid = false;
        } else {
            if (errorSpan && errorSpan.className === "error-text") {
                errorSpan.remove();
            }
        }
    });

    // Fayl tanlanganligini tekshirish
    if (!fileEdit.files.length) {
        isValid = false;
    }

    // Radio tugma tanlanganligini tekshirish
    if (!selectedRadio) {
        isValid = false;
    }

    if (!isValid) {
        return;
    }

    // ✅ FormData yaratish (JSON emas!)
    let formData = new FormData();
    formData.append("editCategoryName", editCategoryName.value);
    formData.append("editCategoryNameText", value);
    formData.append("yearOfCarEdit", yearOfCarEdit.value);
    formData.append("colorOfCarEdit", colorOfCarEdit.value);
    formData.append("probegEdit", probegEdit.value);
    formData.append("file", fileEdit.files[0]); // Fayl obyektini qo‘shish
    formData.append("selectedValue", selectedRadio.value);
    console.log("val:",value, "textName", editCategoryName.value);
    
    fetch(`/api/soldCars/edit/${id}`, {
        method: 'POST',
        body: formData // JSON emas, FormData jo‘natamiz
    })
    .then(res => res.json())
    .then((data) => {
        console.log(data);
        closeModal(id);
        getSoldCars();
    })
    .catch(err => console.error("Xatolik:", err));
}



         function closeModal(id) {
            let modalElement = document.getElementById(`Modal${id}`);
            let modalInstance = bootstrap.Modal.getInstance(modalElement); 
            if (modalInstance) {
                modalInstance.hide(); 
            }
        }
    </script>
</body>
</html>